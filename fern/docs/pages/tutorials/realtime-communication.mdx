---
title: Real-time Agent Communication
subtitle: Building interactive experiences with WebSockets
slug: realtime-communication
---

This tutorial will guide you through building a real-time conversational experience using the AUI WebSocket API. You'll learn how to establish connections, handle streaming responses, and manage the connection lifecycle.

## What You'll Build

By the end of this tutorial, you'll have:

- Established a WebSocket connection to Apollo-1
- Sent messages and received streaming responses
- Handled different message types (text, recommendations, suggestions)
- Implemented proper connection management and error handling

## Prerequisites

- An AUI API key
- A task ID (create one using the REST API first)
- Basic knowledge of WebSockets
- Node.js or a browser environment

## Step 1: Create a Task

First, create a task using the SDK:

<CodeBlocks>
  <CodeBlock title="TypeScript">
    ```typescript
    import { ApolloClient } from '@aui.io/aui-client';

    const client = new ApolloClient({
      networkApiKey: 'YOUR_API_KEY'
    });

    const taskResponse = await client.controllerApi.createTask({
      user_id: 'user_123'
    });

    const taskId = taskResponse.id;
    console.log('Task ID:', taskId);
    ```
  </CodeBlock>
  <CodeBlock title="Python">
    ```python
    from aui import ApolloClient

    client = ApolloClient(network_api_key='YOUR_API_KEY')

    task_response = client.controller_api.create_task(user_id='user_123')

    task_id = task_response.id
    print(f'Task ID: {task_id}')
    ```
  </CodeBlock>
</CodeBlocks>

## Step 2: Establish WebSocket Connection

Connect to the WebSocket API using the SDK:

<CodeBlocks>
  <CodeBlock title="TypeScript">
    ```typescript
    const socket = await client.apolloWsSession.connect({
      debug: true,
      reconnectAttempts: 30
    });

    socket.on('open', () => {
      console.log('✅ Connected to WebSocket');
    });

    socket.on('error', (error) => {
      console.error('WebSocket error:', error);
    });

    socket.on('close', (event) => {
      console.log('Disconnected:', event.code);
    });
    ```
  </CodeBlock>
  <CodeBlock title="Python">
    ```python
    from aui.apollo_ws_session.client import ApolloWsSessionClient

    apollo_ws = ApolloWsSessionClient(client_wrapper=client._client_wrapper)

    with apollo_ws.connect() as socket:
        print('✅ Connected to WebSocket')
        # Your WebSocket code here
    ```
  </CodeBlock>
</CodeBlocks>

## Step 3: Send a Message

Once connected, send a user message:

<CodeBlocks>
  <CodeBlock title="TypeScript">
    ```typescript
    socket.on('open', () => {
      console.log('Connected!');
      
      // Send a message
      socket.sendUserMessage({
        task_id: taskId,
        text: 'I need a microwave with at least 20 liters capacity'
      });
    });
    ```
  </CodeBlock>
  <CodeBlock title="Python">
    ```python
    from aui.types.user_message_payload import UserMessagePayload

    with apollo_ws.connect() as socket:
        # Send message
        message_payload = UserMessagePayload(
            task_id=task_id,
            text='I need a microwave with at least 20 liters capacity'
        )
        socket.send_user_message(message_payload)
    ```
  </CodeBlock>
</CodeBlocks>

## Step 4: Handle Streaming Responses

Handle different message types from the agent:

<CodeBlocks>
  <CodeBlock title="TypeScript">
    ```typescript
    socket.on('message', (message) => {
      // Streaming updates (partial text)
      if (message.channel?.eventName === 'thread-message-text-content-updated') {
        const chunk = message.data?.text || '';
        console.log('Streaming:', chunk);
        // Update UI with streaming text
      }
      
      // Final message (complete response)
      if (message.id && message.text && message.sender) {
        console.log('Complete response:', message.text);
        
        // Product recommendations
        if (message.cards && message.cards.length > 0) {
          console.log('Product recommendations:');
          message.cards.forEach(card => {
            console.log(`- ${card.name} (${card.id})`);
          });
        }
        
        // Follow-up suggestions
        if (message.followupSuggestions) {
          console.log('Suggested questions:', message.followupSuggestions);
        }
        
        // Close after receiving final message
        socket.close();
      }
      
      // Error messages
      if (message.statusCode) {
        console.error('Error:', message.description);
      }
    });
    ```
  </CodeBlock>
  <CodeBlock title="Python">
    ```python
    with apollo_ws.connect() as socket:
        socket.send_user_message(message_payload)
        
        # Iterate over messages
        for message in socket:
            # Streaming updates
            if hasattr(message, 'channel') and message.channel:
                if message.channel.event_name == 'thread-message-text-content-updated':
                    chunk = message.data.text if hasattr(message, 'data') else ''
                    print(f'Streaming: {chunk}')
            
            # Final message
            elif hasattr(message, 'id') and hasattr(message, 'text'):
                print(f'Complete response: {message.text}')
                
                # Product recommendations
                if hasattr(message, 'cards') and message.cards:
                    print('Product recommendations:')
                    for card in message.cards:
                        print(f'- {card.name} ({card.id})')
                
                # Follow-up suggestions
                if hasattr(message, 'followup_suggestions') and message.followup_suggestions:
                    print('Suggested questions:', message.followup_suggestions)
                
                # Break after final message
                break
            
            # Error messages
            elif hasattr(message, 'status_code'):
                print(f'Error: {message.description if hasattr(message, "description") else "Unknown"}')
                break
    ```
  </CodeBlock>
</CodeBlocks>

## Step 5: Complete Working Example

Here's a complete working example:

<CodeBlocks>
  <CodeBlock title="TypeScript">
    ```typescript
    import { ApolloClient } from '@aui.io/aui-client';

    async function realtimeChat() {
      const client = new ApolloClient({
        networkApiKey: 'YOUR_API_KEY'
      });

      // Create task
      const taskResponse = await client.controllerApi.createTask({
        user_id: 'user_123'
      });

      // Connect WebSocket
      const socket = await client.apolloWsSession.connect();

      socket.on('open', () => {
        console.log('✅ Connected');
        
        socket.sendUserMessage({
          task_id: taskResponse.id,
          text: 'Show me gaming laptops under $1500'
        });
      });

      socket.on('message', (message) => {
        // Streaming
        if (message.channel?.eventName === 'thread-message-text-content-updated') {
          console.log('Agent:', message.data?.text);
        }
        
        // Final message
        if (message.id && message.text) {
          console.log('\n✅ Complete:', message.text);
          
          if (message.cards) {
            console.log('\nProducts:');
            message.cards.forEach(card => console.log(`- ${card.name}`));
          }
          
          socket.close();
        }
      });

      socket.on('error', (error) => console.error(error));
    }

    realtimeChat();
    ```
  </CodeBlock>
  <CodeBlock title="Python">
    ```python
    from aui import ApolloClient
    from aui.apollo_ws_session.client import ApolloWsSessionClient
    from aui.types.user_message_payload import UserMessagePayload

    client = ApolloClient(network_api_key='YOUR_API_KEY')

    # Create task
    task_response = client.controller_api.create_task(user_id='user_123')

    # Connect WebSocket
    apollo_ws = ApolloWsSessionClient(client_wrapper=client._client_wrapper)

    with apollo_ws.connect() as socket:
        # Send message
        message_payload = UserMessagePayload(
            task_id=task_response.id,
            text='Show me gaming laptops under $1500'
        )
        socket.send_user_message(message_payload)
        
        # Iterate over messages
        for message in socket:
            # Streaming
            if hasattr(message, 'channel') and message.channel:
                if message.channel.event_name == 'thread-message-text-content-updated':
                    print(f'Agent: {message.data.text}')
            
            # Final message
            elif hasattr(message, 'id') and hasattr(message, 'text'):
                print(f'\n✅ Complete: {message.text}')
                
                if hasattr(message, 'cards') and message.cards:
                    print('\nProducts:')
                    for card in message.cards:
                        print(f'- {card.name}')
                
                break
    ```
  </CodeBlock>
</CodeBlocks>

## Best Practices

### Connection Management

- Implement exponential backoff for reconnections
- Handle different close codes appropriately
- Provide user feedback on connection status

### Message Handling

- Accumulate streaming text chunks properly
- Reset state after complete messages
- Handle all message types gracefully

### Error Handling

- Display user-friendly error messages
- Implement retry logic for transient errors
- Log errors for debugging

### Performance

- Handle streaming updates efficiently
- Close connections when done
- Use the SDK's built-in reconnection logic

## Next Steps

- Learn about [WebSocket Communication](/websocket) concepts
- Explore [Tasks](/tasks) and [Messages](/messages)
- Check the [API Reference](/api-reference) for complete documentation
