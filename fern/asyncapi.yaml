asyncapi: 3.0.0

info:
  title: Agent Controller WebSocket API
  version: 0.5.3
  description: |
    Real-time streaming communication with the Agent Controller for conversational AI interactions.
    
    The WebSocket API enables bidirectional communication for sending messages and receiving 
    streaming responses with product recommendations and follow-up suggestions.
  externalDocs:
    description: Full WebSocket API Documentation
    url: https://docs-v2.aui.io/api/websocket/

servers:
  staging:
    host: api.aui.io
    protocol: wss
    pathname: /ia-controller/api/v1/external/session
    description: Staging WebSocket server
    security:
      - $ref: '#/components/securitySchemes/apiKey'

channels:
  apollo-ws-session:
    address: /ia-controller/api/v1/external/session
    description: WebSocket channel for real-time bidirectional communication with the agent
    messages:
      userMessage:
        $ref: '#/components/messages/UserMessage'
      streamingUpdate:
        $ref: '#/components/messages/StreamingUpdate'
      finalMessage:
        $ref: '#/components/messages/FinalMessage'
      errorMessage:
        $ref: '#/components/messages/ErrorMessage'

operations:
  sendUserMessage:
    action: send
    channel:
      $ref: '#/channels/apollo-ws-session'
    summary: Send a message to the agent
    messages:
      - $ref: '#/channels/apollo-ws-session/messages/userMessage'

  receiveMessages:
    action: receive
    channel:
      $ref: '#/channels/apollo-ws-session'
    summary: Receive streaming updates and final messages
    messages:
      - $ref: '#/channels/apollo-ws-session/messages/streamingUpdate'
      - $ref: '#/channels/apollo-ws-session/messages/finalMessage'
      - $ref: '#/channels/apollo-ws-session/messages/errorMessage'

components:
  securitySchemes:
    apiKey:
      type: httpApiKey
      name: x-network-api-key
      in: header
      description: Your network API key for authentication

  messages:
    UserMessage:
      name: UserMessage
      title: User Message
      summary: Message from user to agent
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserMessagePayload'

    StreamingUpdate:
      name: StreamingUpdate
      title: Streaming Text Update
      summary: Real-time text content updates as agent generates response
      contentType: application/json
      payload:
        $ref: '#/components/schemas/StreamingUpdatePayload'

    FinalMessage:
      name: FinalMessage
      title: Final Complete Message
      summary: Complete response with product cards and follow-up suggestions
      contentType: application/json
      payload:
        $ref: '#/components/schemas/FinalMessagePayload'

    ErrorMessage:
      name: ErrorMessage
      title: Error Message
      summary: Error message sent before connection closure
      description: |
        Sent when errors occur. Connection closes after error message.
        - Code 1008: Authentication or application errors
        - Code 1011: Internal server errors
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ErrorMessagePayload'

  schemas:
    UserMessagePayload:
      type: object
      required:
        - task_id
        - text
      properties:
        task_id:
          type: string
          description: Task identifier
          example: "68e78d0dc5a4b19a030d03d6"
        text:
          type: string
          description: Message text to send
          example: "I am looking for a built-in microwave with at least 20 liters capacity"

    StreamingUpdatePayload:
      type: object
      required:
        - channel
        - data
      properties:
        channel:
          type: object
          required:
            - type
            - channel_name
            - event_name
          properties:
            type:
              type: string
              enum: [WEBSOCKET]
            channel_name:
              type: string
              description: Unique channel identifier
            event_name:
              type: string
              enum: [thread-message-text-content-updated]
        scope:
          type: object
          properties:
            type:
              type: string
              enum: [LLM_ACTIVATION_EXECUTION]
            data:
              type: object
              properties:
                status:
                  type: string
                  enum: [SUCCESS, FAILED, PENDING]
            context:
              type: object
              properties:
                message_id:
                  type: string
                task_id:
                  type: string
                interaction_id:
                  type: string
                pillar:
                  type: string
        data:
          type: object
          required:
            - text
          properties:
            text:
              type: string
              description: Streaming text content
        timestamp:
          type: string
          format: date-time

    FinalMessagePayload:
      type: object
      required:
        - id
        - created_at
        - text
        - sender
        - receiver
      properties:
        id:
          type: string
          example: "54833a6d-c7b4-4395-8ab9-e284c715b975"
        created_at:
          type: string
          format: date-time
          example: "2025-10-19 13:48:13.764000"
        text:
          type: string
          description: Complete response text
        sender:
          $ref: '#/components/schemas/WsActor'
        receiver:
          $ref: '#/components/schemas/WsActor'
        cards:
          type: array
          description: Product recommendation cards
          items:
            $ref: '#/components/schemas/ProductCard'
        followup_suggestions:
          type: array
          description: Suggested follow-up questions
          items:
            type: string

    ProductCard:
      type: object
      required:
        - id
        - name
        - parameters
      properties:
        id:
          type: string
        name:
          type: string
          example: "Panasonic NN-SN98JS"
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/ProductParameter'
        is_recommended:
          type: boolean

    ProductParameter:
      type: object
      required:
        - title
        - value
        - type
      properties:
        title:
          type: string
          description: Parameter name
          example: "Price"
        value:
          oneOf:
            - type: string
            - type: number
            - type: array
            - type: object
              additionalProperties: true
          description: Parameter value (can be string, number, array, or object)
          example: "$358.08"
        type:
          type: string
          enum: [string, numeric, array, object]

    WsActor:
      type: object
      required:
        - id
        - type
      properties:
        id:
          type: string
          example: "intelligent-agent"
        type:
          type: string
          enum: [user, agent]
        email:
          type: string
          format: email
          nullable: true

    ErrorMessagePayload:
      type: object
      required:
        - status_code
        - description
        - message
      properties:
        status_code:
          type: integer
          enum: [422, 500]
          example: 422
        description:
          type: string
          example: "Unprocessable Entity"
        message:
          type: string
        extra_data:
          type: object
          description: Dynamic error context (varies by error type)
          additionalProperties: true

x-examples:
  javascript-client:
    title: JavaScript WebSocket Client
    description: Complete example of connecting and handling messages
    language: javascript
    code: |
      const ws = new WebSocket(
        'wss://api-staging.internal-aui.io/ia-controller/api/v1/external/session?network_api_key=your-api-key'
      );

      ws.onopen = function() {
        console.log('Connected to WebSocket');
        
        // Send a message
        ws.send(JSON.stringify({
          task_id: "68e78d0dc5a4b19a030d03d6",
          text: "I am looking for a built-in microwave with at least 20 liters capacity"
        }));
      };

      ws.onmessage = function(event) {
        const response = JSON.parse(event.data);
        
        // Handle streaming text updates
        if (response.channel?.event_name === 'thread-message-text-content-updated') {
          console.log('Streaming:', response.data.text);
        } 
        // Handle final message with product cards
        else if (response.id) {
          console.log('Final message:', response.text);
          console.log('Product cards:', response.cards);
          console.log('Follow-up suggestions:', response.followup_suggestions);
        }
        // Handle errors
        else if (response.status_code) {
          console.error('Error:', response.message);
        }
      };

      ws.onerror = function(error) {
        console.error('WebSocket error:', error);
      };

      ws.onclose = function(event) {
        console.log('Connection closed:', event.code, event.reason);
        
        if (event.code === 1008) {
          // Authentication or application error
          console.log('Policy violation - check API key or request');
        } else if (event.code === 1011) {
          // Internal server error
          console.log('Internal server error - retry connection');
        }
      };

x-error-handling:
  description: |
    WebSocket Error Handling Behavior
    
    When errors occur:
    1. Server sends error message
    2. Connection closes with specific code:
       - 1008 (Policy Violation): Auth failures, application errors
       - 1011 (Internal Error): Server errors
    
    Best Practices:
    - Check for error messages in onmessage handler
    - Handle disconnection in onclose handler
    - Implement reconnection logic
    - Check close codes to determine error type
      - Queue messages if connection not ready
      - Avoid sending messages too frequently
      - Maintain context across messages in same task

x-message-flow:
  description: |
    Normal Message Flow:
    1. Client connects with network_api_key
    2. Client sends UserMessage with task_id and text
    3. Server sends multiple StreamingUpdate messages (text chunks)
    4. Server sends FinalMessage with complete response and product cards
    5. Client can send additional messages to continue conversation
    
    Error Flow:
    1. Error occurs (authentication, validation, or server error)
    2. Server sends ErrorMessage
    3. Server closes connection with appropriate code (1008 or 1011)
